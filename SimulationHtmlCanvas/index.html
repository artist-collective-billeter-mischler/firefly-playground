<!DOCTYPE html>
<html>

<head>
</head>

<body>
    <canvas id="canvas" width="1000" height="500" style="border:1px solid #000000; margin-left: 100px"></canvas>

    <script>
        const visibilityRadius = 100;

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.addEventListener('click', click);
        let time = 0.0;
        const TAU = Math.PI * 2;
        let selected = null;

        const fireflies = new Array(20);
        for (let i = 0; i < fireflies.length; i += 1) {
            fireflies[i] = {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                f: 1 / 5, // frequency [Hz]
                phi: Math.random() * TAU,
                phiNext: 0,
                drift: Math.random() * 0.0001,
            };
        }

        // 1. click = select | 2. click = move
        function click(event) {
            const mouse = { x: event.offsetX, y: event.offsetY };
            if (selected === null) {
                for (let i = 0; i < fireflies.length; i += 1) {
                    if (distance(fireflies[i], mouse) < 10) {
                        selected = i;
                        return;
                    }
                }
            } else {
                fireflies[selected].x = mouse.x;
                fireflies[selected].y = mouse.y;
                selected = null;
            }
        }

        function isOn(ff, t) {
            const x = Math.sin(TAU * ff.f * t + ff.phi);
            return x > 0.7;
        }

        function distance(ff1, ff2) {
            const dx = ff1.x - ff2.x;
            const dy = ff1.y - ff2.y;
            const d = Math.sqrt(dx * dx + dy * dy);
            return d;
        }

        function isClose(ff1, ff2) {
            return distance(ff1, ff2) < visibilityRadius;
        }

        function update(t) {
            for (let i = 0; i < fireflies.length; i += 1) {
                fireflies[i].phiNext = fireflies[i].phi;
                for (let j = 0; j < fireflies.length; j += 1) {
                    if (i != j) {
                        if (isClose(fireflies[i], fireflies[j])) {
                            if (fireflies[j].phi > fireflies[i].phi) {
                                fireflies[i].phiNext += 0.005;
                            }
                            if (fireflies[j].phi < fireflies[i].phi) {
                                fireflies[i].phiNext -= 0.005;
                            }
                        }
                    }
                }
            }

            for (let i = 0; i < fireflies.length; i += 1) {
                fireflies[i].phi = fireflies[i].phiNext + fireflies[i].drift;
            }
        }

        function draw(t) {
            ctx.fillStyle = 'white';
            ctx.font = '8px Tahoma';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < fireflies.length; i += 1) {
                const ff = fireflies[i];

                ctx.fillStyle = isOn(ff, t) > 0.0 ? '#f00' : '#f99';
                ctx.beginPath();
                ctx.arc(ff.x, ff.y, 8, 0, 2 * Math.PI);
                ctx.fill();

                ctx.strokeStyle = '#000';
                ctx.strokeText(ff.phi.toFixed(2), ff.x, ff.y);

                ctx.strokeStyle = '#999';
                ctx.beginPath();
                ctx.arc(ff.x, ff.y, visibilityRadius, 0, 2 * Math.PI);
                ctx.stroke();
            }
        }

        function tick() {
            time += 0.1;
            update(time);
            draw(time);
        }

        setInterval(tick, 100);
    </script>
</body>

</html>